# NinjaTrader 8 Implementation Design — 80P + 20P + VA Edge Fade

**Date:** 2026-02-24
**Purpose:** Design document so any Claude session (or human developer) can build NinjaTrader 8 indicators/strategies from the backtested research.
**Existing Code:** `output/ninjatrader/DaltonPlaybookStrategy.cs` — day-type playbook (extend, don't replace).

---

## Table of Contents

1. [Architecture Overview](#1-architecture-overview)
2. [Shared Components](#2-shared-components)
3. [Strategy 1: 80P Rule](#3-strategy-1-80p-rule)
4. [Strategy 2: 20P Rule](#4-strategy-2-20p-rule)
5. [Strategy 3: VA Edge Fade](#5-strategy-3-va-edge-fade)
6. [Gotchas & Design Warnings](#6-gotchas--design-warnings)
7. [Testing Protocol](#7-testing-protocol)
8. [Backtesting Methodology — How We Tested](#8-backtesting-methodology)

---

## 1. Architecture Overview

### File Structure

```
NinjaTrader 8/
├── Indicators/
│   ├── PriorSessionVA.cs          ← Value Area computation (shared)
│   ├── VAEdgeDetector.cs          ← Detects pokes/sweeps at VA boundaries
│   └── IBTracker.cs               ← Initial Balance tracking (shared)
│
├── Strategies/
│   ├── EightyPercentRule.cs       ← 80P: opens outside VA, fades back in
│   ├── TwentyPercentRule.cs       ← 20P: IB extension breakout
│   ├── VAEdgeFade.cs              ← VA Edge Fade: poke outside VA, fade
│   └── DaltonPlaybookStrategy.cs  ← Existing day-type playbook
│
└── AddOns/
    └── VALevelsManager.cs         ← Manages prior-session VA state across bars
```

### Data Requirements

All three strategies need:
- **1-minute bars** as the primary data series
- **5-minute bars** as a secondary series (for acceptance/inversion candle detection)
- **ATR(14)** on 1-min bars
- **Prior session Value Area** (VAH, VAL, POC) — computed from ETH (overnight + RTH) data

### NinjaTrader Multi-Series Setup

```csharp
protected override void OnStateChange()
{
    if (State == State.Configure)
    {
        // Primary: 1-min bars
        // Already set by chart timeframe

        // Secondary: 5-min bars for acceptance/inversion detection
        AddDataSeries(BarsPeriodType.Minute, 5);

        // ATR on primary series
        atr14 = ATR(14);
    }
}
```

---

## 2. Shared Components

### 2.1 Prior Session Value Area (`PriorSessionVA.cs`)

**Algorithm:** CBOT Standard POC Expansion (70% volume)

```
INPUTS:
  - Session definition: ETH (18:00 prior day → 17:00 current day)
    OR RTH (09:30 → 16:15) — ETH is recommended by research
  - Tick size: 0.25 (NQ)
  - VA percentage: 70%

COMPUTATION:
  1. Build volume profile: distribute each bar's volume across
     all price bins (low → high) at tick_size resolution
  2. Find POC: price bin with maximum volume
  3. Expand outward from POC:
     - Compare volume one bin above VAH vs one bin below VAL
     - Add the side with more volume
     - Repeat until 70% of total volume is captured
  4. Output: POC, VAH, VAL, VA_Width

CRITICAL: Use ETH (overnight + RTH) data, not RTH-only.
  - ETH VA width: median 158 pts (captures overnight institutional positioning)
  - RTH VA width: median 126 pts (misses overnight levels)
  - ETH outperforms RTH in all backtested configurations
```

**NinjaTrader Implementation Notes:**
- Use `SessionIterator` to identify session boundaries
- Store prior session VA in class variables, update on new session
- The `Bars.GetSessionEndTime()` method helps identify session transitions
- For ETH sessions, set session template to include globex/overnight data
- **Min VA width filter: 25 pts** — skip if VA is too narrow

### 2.2 5-Minute Bar Aggregation

NinjaTrader handles this natively via `AddDataSeries(BarsPeriodType.Minute, 5)`. Access 5-min bars via `BarsInProgress == 1`.

```csharp
protected override void OnBarUpdate()
{
    if (BarsInProgress == 0) // 1-min bars
    {
        // Main logic, trade replay, stop/target management
    }
    else if (BarsInProgress == 1) // 5-min bars
    {
        // Acceptance detection, inversion candle detection
    }
}
```

### 2.3 Common Stop/Target Functions

```
STOP TYPES:
  VA_EDGE_10:    VAH + 10 (SHORT) or VAL - 10 (LONG)
  TWO_ATR:       Entry ± 2 * ATR(14)
  ONE_ATR:       Entry ± 1 * ATR(14)
  EIGHTY_PT:     Entry ± 80
  SWING:         5-min candle extreme ± 5pt buffer

TARGET TYPES:
  OPPOSITE_VA:   VAL (SHORT) or VAH (LONG)
  POC:           Prior session POC
  MID_VA:        (VAH + VAL) / 2
  R_MULTIPLE:    Entry ± (risk * N) where N = 1, 2, 4
  TRAIL_02ATR:   Trailing stop at 0.2 * ATR from bar extreme (see below)

TRAILING STOP LOGIC (0.2 ATR):
  Initialize trail_stop = initial_stop
  On each bar:
    SHORT: new_trail = bar.Low + 0.2 * ATR
           if new_trail < trail_stop: trail_stop = new_trail
    LONG:  new_trail = bar.High - 0.2 * ATR
           if new_trail > trail_stop: trail_stop = new_trail
  Exit when price hits trail_stop
```

---

## 3. Strategy 1: 80P Rule

### Setup Condition

```
IF prior_session_VA exists AND VA_width >= 25 pts:
  RTH_open = first 1-min bar open after 09:30 ET
  IF RTH_open > VAH → potential SHORT (gap up failed)
  IF RTH_open < VAL → potential LONG (gap down failed)
  IF RTH_open inside VA → NO SETUP
```

### Entry Models (3 options, implement all as parameters)

#### Model A: Acceptance Close (Baseline)
```
WAIT for 1 x 30-min bar to close INSIDE VA after opening outside
  SHORT: 30-min close < VAH
  LONG:  30-min close > VAL
ENTRY: market at close of acceptance bar
RISK:  59p average
```

#### Model B: Limit 50% VA Depth (Best $/Mo)
```
AFTER price touches VA boundary (first 1-min bar inside VA):
  Compute limit_price = VA_boundary + 0.50 * VA_width toward opposite VA
    SHORT: limit_price = VAH - 0.50 * (VAH - VAL)  → near POC
    LONG:  limit_price = VAL + 0.50 * (VAH - VAL)  → near POC
  Place LIMIT order at limit_price
  Cancel if not filled by 13:00 ET
RISK:  79p average
```

#### Model C: 100% Retest / Double Top-Bottom (Best WR)
```
AFTER acceptance bar closes inside VA (same as Model A):
  Identify the acceptance candle high/low
  SHORT: place LIMIT SELL at candle_high (price bounces back up to form double top)
  LONG:  place LIMIT BUY at candle_low (price pulls back down to form double bottom)
  Cancel if not filled within 2 hours of acceptance
RISK:  60p average
```

### Stop (all models)

```
STOP = VA_edge + 10pt buffer
  SHORT: stop = VAH + 10
  LONG:  stop = VAL - 10

DO NOT USE:
  - Candle-based stops → 5-14% WR catastrophic failure
  - Wider buffers (20pt, 30pt) → PF degrades
  - ATR-based stops on 80P → PF 1.14 vs 1.56 (VA edge wins)
```

### Target (configurable parameter)

```
DEFAULT: 4R (4 × risk distance from entry)
ALTERNATIVES:
  - opposite_va: target the other side of VA
  - 2R: 2 × risk (higher WR, lower $/mo)
  - POC: target the POC level
```

### Parameters for NT8

```csharp
// Entry model
public enum EntryModel80P { AcceptanceClose, Limit50VA, Retest100 }
public EntryModel80P EntryMode { get; set; } = EntryModel80P.Limit50VA;

// Target
public enum TargetMode80P { FourR, TwoR, OneR, OppositeVA, POC }
public TargetMode80P TargetMode { get; set; } = TargetMode80P.FourR;

// Stop buffer beyond VA edge
public int StopBuffer { get; set; } = 10;

// Filters
public int MinVAWidth { get; set; } = 25;
public TimeSpan EntryCutoff { get; set; } = new TimeSpan(13, 0, 0);
public TimeSpan ExitCutoff { get; set; } = new TimeSpan(15, 30, 0);

// Position sizing
public int Contracts { get; set; } = 5;
```

### Key Statistics (reference for validation)

| Config | N | T/Mo | WR | PF | $/Mo |
|--------|---|------|-----|-----|------|
| Limit 50% VA + 4R | 47 | 4.0 | 44.7% | 2.57 | $1,922 |
| 100% Retest + 2R | 35 | 3.0 | 65.7% | 3.45 | $915 |
| Acceptance + 4R | 60 | 5.1 | 38.3% | 1.70 | $955 |

---

## 4. Strategy 2: 20P Rule

### Setup Condition

```
AFTER IB completes (09:30-10:30 ET, first 60 1-min bars):
  Compute IB_HIGH, IB_LOW, IB_RANGE = IB_HIGH - IB_LOW
  IF IB_RANGE < 20 pts → NO SETUP (too narrow, filter noise)

POST-IB: watch for IB extension
  Build 5-min bars from post-IB 1-min data
  Count consecutive 5-min closes ABOVE IB_HIGH → LONG signal
  Count consecutive 5-min closes BELOW IB_LOW → SHORT signal

  IF 3 consecutive 5-min closes beyond IB boundary:
    → ENTRY triggered
```

### Entry

```
ENTRY: market at close of 3rd consecutive 5-min bar beyond IB
  Must be before 13:00 ET
```

### Stop Models (implement as parameter)

```
RECOMMENDED: 2x ATR
  LONG:  stop = entry_price - 2 * ATR(14)
  SHORT: stop = entry_price + 2 * ATR(14)
  Median risk: 32 pts

ALTERNATIVE: 1x ATR (aggressive scalp)
  Median risk: 16 pts — use with 4R target

DO NOT USE:
  - IB boundary stop (opposite IB edge) → 219pt risk, PF 1.25
  - VWAP stop → 133pt, too wide
  - POC stop → 365pt, absurd
```

### Target

```
RECOMMENDED: 2R (2 × stop distance from entry)
  With 2x ATR stop: ~64pt target, 45.5% WR, PF 1.78

ALTERNATIVE: 4R with 1x ATR stop
  ~64pt target from 16pt risk, 29.5% WR, PF 1.71
```

### Parameters for NT8

```csharp
// IB Extension acceptance
public int AcceptancePeriodMin { get; set; } = 5;   // 5-min bars
public int AcceptanceCount { get; set; } = 3;        // 3 consecutive

// Stop
public enum StopMode20P { TwoATR, OneATR, Swing3Bar, Swing3BarCappedATR }
public StopMode20P StopMode { get; set; } = StopMode20P.TwoATR;

// Target
public enum TargetMode20P { TwoR, ThreeR, FourR }
public TargetMode20P TargetMode { get; set; } = TargetMode20P.TwoR;
```

### Key Statistics

| Config | N | T/Mo | WR | PF | $/Mo | Risk |
|--------|---|------|-----|-----|------|------|
| 3x5min + 2x ATR + 2R | 44 | 3.7 | 45.5% | 1.78 | $496 | 32p |
| 3x5min + 1x ATR + 4R | 44 | 3.7 | 29.5% | 1.71 | $305 | 16p |
| Swing capped 2ATR + 2R | 17 | 1.4 | 52.9% | 1.89 | $170 | 26p |

---

## 5. Strategy 3: VA Edge Fade

### Setup Condition

```
FOR EACH 5-min bar during RTH (after IB, before 13:00 ET):
  IF bar.High > VAH AND bar qualifies as rejection → SHORT poke event
  IF bar.Low < VAL AND bar qualifies as rejection → LONG poke event

"Qualifies as rejection" means one of:
  A) Inversion candle: high > VAH AND close < VAH AND close < open (SHORT)
     OR: low < VAL AND close > VAL AND close > open (LONG)
  B) 2x5min: this bar closes inside VA AND next 5-min bar also closes inside VA
```

### Poke Tracking

```
Track pokes per-edge per-session:
  vah_poke_count = 0  (incremented each time a qualifying SHORT event occurs)
  val_poke_count = 0  (incremented each time a qualifying LONG event occurs)

  poke_number = 1 → "first touch"
  poke_number = 2 → "second test" (retest)
  poke_number >= 3 → also tradeable but lower edge
```

### Entry Models (4 options)

#### Model A: Inversion Candle (Market Entry)
```
TRIGGER: 5-min inversion candle at VA edge (see qualification above)
ENTRY:   market at close of inversion candle
WHEN:    any poke number (1st, 2nd, 3rd+)
```

#### Model B: 2x5min Close (Market Entry)
```
TRIGGER: 2 consecutive 5-min candles close back inside VA after poke
ENTRY:   market at close of 2nd qualifying 5-min bar
WHEN:    any poke number
```

#### Model C: Limit at Sweep Extreme (2nd Test Only)
```
TRIGGER: 2nd+ poke at same VA edge
ENTRY:   limit order at the sweep extreme (bar high for SHORT, bar low for LONG)
         This is effectively a double top/bottom entry
WHEN:    poke_number >= 2 only
NOTE:    With VA edge stop, risk is only ~9pts. Very tight.
```

#### Model D: Limit at VA Edge (2nd Test Only)
```
TRIGGER: 2nd+ poke at same VA edge
ENTRY:   limit order at exact VAH (SHORT) or VAL (LONG)
         Wait for price to return to the edge
WHEN:    poke_number >= 2 only
```

### Stop Models

```
RECOMMENDED for market entries (inversion/2x5m):
  2 ATR:     entry ± 2 * ATR(14)     → ~46pt risk
  Swing:     5-min bar extreme ± 5pt  → ~57pt risk

RECOMMENDED for limit entries (limit_edge, limit_sweep):
  2 ATR:     entry ± 2 * ATR(14)     → ~46pt risk (limit_edge)
  Swing:     candle extreme ± 5pt     → ~21pt risk (limit_edge)
  VA edge:   VAH + 10 / VAL - 10     → ~9pt risk (limit_sweep) ← very tight

DO NOT USE:
  80pt fixed → oversized for typical 12pt median sweep
  0.5 ATR trail → universally fails (dead zone)
```

### Target Models

```
SCALP:    0.2 ATR trailing stop (62-70% WR, small $ per trade)
STANDARD: POC (55% WR, $1,309/mo with limit_edge + 2ATR)
          1R (60% WR with limit_edge)
RUNNERS:  2R, 4R, opposite_va (30-42% WR, big winners)
```

### Parameters for NT8

```csharp
// Entry
public enum EntryModelVAFade { Inversion, TwoX5Min, LimitSweep, LimitEdge }
public EntryModelVAFade EntryMode { get; set; } = EntryModelVAFade.LimitEdge;

// Which pokes to trade
public bool TradeFirstTouch { get; set; } = false;   // poke #1
public bool TradeSecondTest { get; set; } = true;     // poke #2 (recommended)
public bool TradeThirdPlus { get; set; } = false;     // poke #3+

// Stop
public enum StopModeVAFade { TwoATR, EightyPt, VAEdge10, Swing }
public StopModeVAFade StopMode { get; set; } = StopModeVAFade.TwoATR;

// Target
public enum TargetModeVAFade { Trail02ATR, Trail05ATR, OneR, TwoR, FourR, POC, MidVA, OppositeVA }
public TargetModeVAFade TargetMode { get; set; } = TargetModeVAFade.POC;
```

### Key Statistics

| Config | N | T/Mo | WR | PF | $/Mo | Risk |
|--------|---|------|-----|-----|------|------|
| Limit edge + 2ATR + POC (2nd) | 120 | 10.2 | 55.0% | 1.63 | $1,309 | 46p |
| 2x5m + 2ATR + 0.2 trail (combined) | 257 | 21.8 | 62.6% | 4.60 | $913 | 47p |
| Limit edge + Swing + 1R (2nd) | 120 | 10.2 | 70.0% | 2.25 | $813 | 21p |
| Limit sweep + VA edge + 1R (2nd) | 105 | 8.9 | 72.4% | 5.38 | $533 | 9p |
| 1st SHORT + 2x5m + 0.2 trail | 80 | 6.8 | 70.0% | 7.28 | $396 | 46p |

---

## 6. Gotchas & Design Warnings

### CRITICAL — Will Break Your Strategy If Ignored

#### 1. Candle-Based Stops on Retest Entries = Catastrophic Failure
```
NEVER use the acceptance/rejection candle extreme as the stop for any
retest or limit entry model. The candle extreme is INSIDE the VA noise
zone. Any small oscillation triggers the stop.

PROVEN: Candle stops → 5-14% WR (catastrophic)
        VA edge stops → 58-66% WR (correct)

This is the single biggest gotcha in the entire system.
```

#### 2. 0.5 ATR Trail Is a Dead Zone
```
The 0.5 ATR trailing stop fails in EVERY configuration tested (500+ configs).
It's too wide to capture the quick scalp (0.2 ATR works) and too tight for
a real trend move (fixed R-multiples work). Never use it.

0.2 ATR trail: 60-70% WR, PF 1.5-7.3 ← works
0.5 ATR trail: 25-40% WR, PF 0.3-0.8 ← universally fails
```

#### 3. ETH VA vs RTH VA — Must Use ETH
```
The entire system was researched on ETH (overnight + RTH) Value Area.
RTH-only VA produces different levels and lower performance.

ETH VA: captures overnight institutional positioning, wider VA (158p median)
RTH VA: misses overnight, narrower VA (126p median), lower PF

If your NinjaTrader session template only includes RTH data, the VA levels
will be WRONG and all statistics above will not apply.
```

#### 4. Entry Cutoff Is Hard at 13:00 ET
```
No new entries after 13:00 ET. Late entries (after lunch) have materially
worse performance because:
  - VA has already been traversed by then in most sessions
  - Remaining time-to-target is too short for larger R-multiples
  - The "failed breakout" thesis weakens as the day progresses
```

#### 5. 80P Stop Widening Destroys P&L
```
Counterintuitive: wider stops on 80P do NOT help.
  10pt buffer: PF 1.56
  20pt buffer: PF 1.34
  30pt buffer: PF 0.83 (losses)
  60pt buffer: catastrophic

76% of stopped 80P trades were LEGITIMATE FAILURES — the setup was wrong.
Wider stops just add risk to trades that were going to fail anyway.
```

#### 6. 80P Acceptance Is a Coin Flip
```
After the 30-min acceptance bar closes inside VA:
  45% → price continues deeper into VA (setup works)
  45% → price reverses back out (breakout was real, acceptance was pullback)
  10% → chop

This is why deeper entries (Limit 50% VA) and retests (100% double top/bottom)
dramatically outperform the acceptance close entry. They filter out the 45%
that immediately reverse.
```

#### 7. NQ Has a Structural Long Bias
```
Every short-only strategy on VA Edge Fade first-touch is weaker in $ than
LONG-and-SHORT combined. BUT SHORT first-touch has the highest WR (70%).

This means: SHORT fades at VAH work more often but for smaller moves.
LONG fades at VAL work less often but catch bigger reversals.

For the 80P rule, direction doesn't matter — both sides work equally.
For the 20P rule, LONG outperforms SHORT with tight stops (PF 1.98 vs 1.58).
```

### MODERATE — Performance Degradation If Ignored

#### 8. 20P IB Boundary Stop = 219pt Average Risk
```
No human trader would place their stop at the opposite IB boundary for an
IB extension breakout. That's 219 pts average risk.

Always use structure-based stops for 20P:
  2x ATR → 32pt (85% tighter than IB boundary)
  1x ATR → 16pt (92% tighter)
  Swing  → 41pt (80% tighter)
```

#### 9. VA Edge Fade — 80pt Stop Is Oversized
```
Median sweep depth is only 12.1 pts beyond VA edge. An 80pt stop means
you're risking 80pt to capture a move that starts 12pt outside VA.

2 ATR (46pt) is the right size — wide enough for noise, tight enough
that winners pay for losers. 80pt only works with limit_edge entries
where the larger target offsets the wider stop.
```

#### 10. Session Date Boundary for Overnight Data
```
When computing ETH VA, bars from 18:00 onward belong to the NEXT session.
E.g., bars at 20:00 on Monday count as Tuesday's session.

  evening_mask = timestamp.time >= 18:00
  session_date = date + 1 day for evening bars

Get this wrong and your VA levels will be shifted by one day.
```

#### 11. 3x5min Is Specifically Better Than 2x5min for 20P
```
20P entry model comparison:
  2x5min: WR 37.3%, PF 1.52
  3x5min: WR 45.5%, PF 1.78   ← 8% WR improvement, 17% PF improvement
  1x15min: WR 35.3%, PF 1.37
  1x30min: WR 27.1%, PF 0.70  ← catastrophic

The extra 5 minutes of patience (3x5min = 15 min) filters out false
breakouts. Don't rush the entry.
```

#### 12. Limit Entries Have Fill Rate Constraints
```
80P Limit 50% VA: 78% fill rate (22% of sessions, price never reaches POC)
80P 100% Retest:  58% fill rate (42% missed — price doesn't pull back)

VA Edge Limit Edge: ~85% fill rate (depends on how far price moves away)
VA Edge Limit Sweep: higher fill (price returns to sweep extreme)

Build cancellation logic: cancel unfilled limits at entry cutoff (13:00 ET).
Don't let limit orders linger into the afternoon.
```

### MINOR — Nice to Have

#### 13. Combined Scoring for Confluence
```
Best trades across all strategies share these traits:
  - Entry depth > 40% into VA (80P winners at 45% vs losers at 23%)
  - ATR and swing stop agree (swing within 2x ATR → PF 1.89 on 20P)
  - Poke depth 10-25 pts beyond VA edge (sweet spot for VA Edge Fade)
  - 2nd test > 1st test for limit entries (confirmation adds edge)

Consider adding a "confluence score" indicator that highlights when
multiple conditions align.
```

#### 14. Time-of-Day Effect
```
Best window for all three strategies: 10:00 - 12:00 ET
  - 80P: acceptance usually happens 10:30-11:30
  - 20P: IB extension confirms by 10:45 (3x5min after IB ends at 10:30)
  - VA Edge Fade: first pokes happen 10:00-11:30 typically

After 12:00 ET, edge degrades significantly. Hard cutoff at 13:00 ET.
```

---

## 7. Testing Protocol

### Step 1: Validate VA Computation
```
1. Load ETH data for NQ (18:00-17:00 sessions)
2. Compute VA for 10 known sessions
3. Compare VAH/VAL/POC to TradingView or Sierra Chart
4. Tolerance: ±2 ticks (±0.50 pts) due to different bar timing
```

### Step 2: Validate Event Detection
```
80P: Count sessions where RTH opens outside prior VA
     Expected: ~67% of sessions (174/259)

20P: Count sessions where IB extends with 3x5min acceptance
     Expected: ~17% of sessions (44/259)

VA Edge Fade: Count poke/rejection events
     Expected: ~2.4 per session (620/259)
```

### Step 3: Paper Trade Validation
```
Run all three strategies in NinjaTrader SIM for 1 month.
Compare trade-by-trade results against Python backtest output.

Key validation metrics:
  - Same number of signals triggered
  - Entry prices within ±1 pt of backtest
  - Stop/target levels match exactly
  - Same exit reasons (STOP/TARGET/EOD)
```

### Step 4: Forward Test
```
Run in SIM with real-time data for 2-4 weeks.
Compare live fills vs backtest expectations.
Key difference: slippage may be higher/lower than 0.50pt assumption.
```

---

## 8. Backtesting Methodology — How We Tested

### Data Pipeline

```
Source: NQ 1-min volumetric bars (BookMap export)
Columns: timestamp, open, high, low, close, volume, vol_delta,
         ask_vol, bid_vol, trades

Pipeline:
  1. load_csv('NQ')                  → 354,387 raw bars (12 months)
  2. filter_rth(df)                  → 99,514 RTH bars
  3. compute_all_features(df)        → adds IB, day type, ATR, EMA, RSI,
                                        VWAP, FVG, delta percentile, etc.
  4. compute_session_value_areas()   → VAH/VAL/POC per session (ETH data)
  5. Strategy-specific detection     → find setups per session
  6. Bar-by-bar replay               → simulate each trade tick-by-tick
```

### Bar-by-Bar Replay Logic

Every trade is simulated by iterating through remaining 1-min bars after entry:

```python
for each bar after entry:
    # Check time cutoff
    if bar.time >= 15:30 → exit at bar.close, reason = 'EOD'

    # Track excursions
    MFE = max(MFE, favorable_move)
    MAE = max(MAE, adverse_move)

    # Check stop FIRST (conservative: stop fills before target on same bar)
    if direction == LONG and bar.low <= stop_price → exit at stop, reason = 'STOP'
    if direction == SHORT and bar.high >= stop_price → exit at stop, reason = 'STOP'

    # Check target
    if direction == LONG and bar.high >= target_price → exit at target, reason = 'TARGET'
    if direction == SHORT and bar.low <= target_price → exit at target, reason = 'TARGET'

    # For trailing stops: update trail on each bar
    if trailing:
        update trail_stop based on bar extreme - trail_distance
        check if trail_stop was hit
```

**Important:** Stop is checked BEFORE target on each bar. This is conservative — on bars where both stop and target are hit, we assume the stop was hit first. This slightly understates performance.

### Cost Model

```
Slippage:    0.50 pts per trade (entry + exit combined)
Commission:  $1.24 per contract per trade
Contracts:   5 MNQ ($2/pt per contract)

PnL formula:
  LONG:  pnl_pts = exit_price - entry_price - 0.50
  SHORT: pnl_pts = entry_price - exit_price - 0.50
  pnl_dollars = pnl_pts * $2/pt * 5 contracts - $1.24 * 5

  Net cost per trade: $0.50 * $2 * 5 + $1.24 * 5 = $5.00 + $6.20 = $11.20
```

### Configuration Testing Matrix

```
80P Rule (optimize_80p.py):
  - 4 VA sources × 4 acceptance periods × 4 target modes = 64 base configs
  - + 6 stop buffers × 4 targets = 24 stop configs
  - + 5 VA depth entries × 4 targets = 20 limit configs
  - + 5 retest levels × 3 stop modes × 4 targets = 60 retest configs
  Total: ~160 configurations

20P Rule (diagnose_20p_v2.py):
  - 4 entry periods × 8 stop types × 4 targets = 128 base configs
  - + swing capped variants = 200+ configs

VA Edge Fade (study_va_edge_fade.py):
  - 4 entry models × 4 stop types × 8 targets = 128 per poke type
  - × 5 poke subsets (1st, 2nd, combined, shorts, retest limit)
  Total: ~500 configurations

GRAND TOTAL: ~860+ configurations tested
```

### Statistical Reporting

For each configuration, we report:
```
N:          Total trades
T/Mo:       Trades per month (N / 11.8 months)
WR:         Win rate (% of trades with positive P&L)
PF:         Profit factor (gross wins / gross losses)
$/Mo:       Monthly P&L in dollars
Avg Win:    Average winning trade in dollars
Avg Loss:   Average losing trade in dollars
Risk:       Average risk in points (entry to stop)
MFE:        Average Maximum Favorable Excursion (best unrealized profit)
MAE:        Average Maximum Adverse Excursion (worst unrealized loss)
S/T/E:      Exit breakdown (Stopped / Target hit / EOD exit)
```

### Reproducibility

All studies are fully reproducible:
```
python optimize_80p.py           → 80P full optimization
python diagnose_20p_v2.py        → 20P structure stops
python study_va_edge_fade.py     → VA Edge Fade full study
```

Data files are in `data/` directory. All indicator code in `indicators/`. All session/feature engineering in `data/`.

---

## 9. Quick-Reference Decision Tree

```
New RTH Session Opens:

├── Opens OUTSIDE prior VA?
│   ├── YES → 80P RULE candidate
│   │   ├── Does price re-enter VA? → Check acceptance model
│   │   │   ├── Limit 50% VA filled? → TRADE (best: $1,922/mo)
│   │   │   ├── Acceptance bar + 100% retest? → TRADE (best WR: 65.7%)
│   │   │   └── Acceptance bar only? → TRADE (baseline: $955/mo)
│   │   │
│   │   └── IB extends AWAY from VA (3x5min beyond IB)?
│   │       └── 20P RULE → TRADE (2x ATR stop, 2R target: $496/mo)
│   │
│   └── NO (opens inside VA or near edge)
│       └── Watch VA EDGE throughout the day
│           ├── Price pokes outside VA edge (5-min bar)?
│           │   ├── Inversion candle? → TRADE (1st touch or 2nd test)
│           │   ├── 2x 5-min close back inside? → TRADE
│           │   └── 2nd+ poke? → Place LIMIT at edge (best: $1,309/mo)
│           └── No poke → no VA Edge Fade setup
```

---

*Design document generated: 2026-02-24*
*For NinjaTrader 8 implementation by any Claude session or human developer*
*Reference scripts: optimize_80p.py, diagnose_20p_v2.py, study_va_edge_fade.py*
